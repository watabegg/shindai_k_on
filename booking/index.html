<?php

    session_start();

    require('../common/php/base.php');

    $today = new DateTime();
    
    //GETの取得
    $days = $_GET['day'] ?? $today->format('Y-m-d');
    $num = $_GET['num'] ?? 0;
    $times = $time[$num];


    $timeselect = '<select name="time" required>';
    for($i=0; $i < count($time); $i++){
        if($i == $num){
            $timeselect .= '<option value="'. $i . '" selected>' . $time[$i] . '</option>';
        }
        else{
            $timeselect .= '<option value="'. $i . '">' . $time[$i] . '</option>';
        }
    }
    $timeselect .= '<option value='. count($time) .'>ユーザー入力(備考に記入してください)</option></select>';

    $dayselect = '<input type="date" name="day" value="'. $days . '" required>';

    $page_flag = 0;

    //確認フォームがPOSTされたときの処理
    if(isset($_POST['form_confirm'])) { 
        $page_flag = 1;

        $select_day = htmlspecialchars($_POST['day'], ENT_QUOTES);
        $select_time = htmlspecialchars($_POST['time'], ENT_QUOTES);
        $regist_name = htmlspecialchars($_POST['regist_name'], ENT_QUOTES);
        $part = $_POST['part'];
        $otherpart = htmlspecialchars($_POST['otherpart'], ENT_QUOTES);
        $remark = htmlspecialchars($_POST['remark'], ENT_QUOTES);
        $name = htmlspecialchars($_POST['name'], ENT_QUOTES);
        $password = htmlspecialchars($_POST['password'], ENT_QUOTES);

        //素数の積
        $part_pro = array_product($part);

        //パスワード暗号化(文字数のみ'･'で取得)
        $pass_hash = password_hash($password, PASSWORD_DEFAULT);
        $password_len = str_repeat('･', mb_strlen($password));

        $YMD_day = str_replace('-', '', $select_day);
        //12桁のID(なんかうまく動かない)
        $booking_id = $YMD_day . sprintf('%02d', $select_time) . sprintf('%06d', $part_pro) . $otherpart;

        //データを一時的にCSVに格納
        $uniq_name = uniqid('', true);
        $csv_date = [$booking_id, $select_day, $select_time, $regist_name, $part_pro, $otherpart, $remark, $name, $pass_hash];
        $csv_name = $uniq_name. '.csv';
        $f = fopen($csv_name, "w");
        fputcsv($f, $csv_date);
        fclose($f);
    }
    //予約フォームがPOSTされたときの処理
    elseif(isset($_POST['form_submit'])){
        $page_flag = 2;

        //CSVを読んで削除
        $csv_name = $_POST['uniq_csv'].'.csv';
        $csv_file = fopen($csv_name, "r");
        $csv_date = fgetcsv($csv_file);
        fclose($csv_file);
        unlink($csv_name);

        list($booking_id, $select_day, $select_time, $regist_name, $part_pro, $otherpart, $remark, $name, $pass_hash) = $csv_date;

        $localdsn = 'mysql:dbname=reservation;host=localhost;charset=utf8';
        $localuser = 'root';
        $localpass = '';
    
        try{
            $dbh = new PDO($localdsn, $localuser, $localpass);
            $dbh->query("INSERT INTO booking (booking_id, day, time, regist_name, part, otherpart, remark, name, password)
             VALUES ('$booking_id', '$select_day', '$select_time', '$regist_name', '$part_pro', '$otherpart','$remark', '$name', '$pass_hash')");
        }catch (PDOException $e) {
            print 'エラー' .PHP_EOL. $e->getMessage();
        }
    }
    //戻るフォームがPOSTされたときの処理
    elseif(isset($_POST['form_back'])){
        $page_flag = 0;

        //CSVを削除
        $csv_name = $_POST['uniq_csv'].'.csv';
        unlink($csv_name);
    }

    function booking(){
        global $dayselect, $timeselect;
        echo <<<_HTML_
        <h1 class="title">信州大学軽音楽部 予約フォーム</h1>
        <div id="bookingMain">
            <form method="POST" action="">
            <table>
                <tr>
                    <td class="menu">予約日：</td>
                    <td> $dayselect </td>
                </tr>
                <tr>
                    <td class="menu">予約時間：</td>
                    <td> $timeselect </td>
                </tr>
                <tr>
                    <td class="menu">登録名：</td>
                    <td><input type="text" name="regist_name" maxlength="30" placeholder="例：ギター個人練習" required></td>
                </tr>
                <tr>
                    <td class="menu">パート：</td>
                    <td>
                        <select multiple="multiple" class="multiple-select" name="part[]" required>
                            <option value="2" selected>ボーカル</option>
                            <option value="3">ギター(マーシャル)</option>
                            <option value="5">ギター(ジャズコーラス)</option>
                            <option value="7">ベース</option>
                            <option value="11">ドラム</option>
                            <option value="13">キーボード</option>
                            <option value="17">その他</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="menu">他パート参加：</td>
                    <td>
                        <input type="radio" name="otherpart" value="1">あり
                        <input type="radio" name="otherpart" value="0" checked>なし
                    </td>
                </tr>
                <tr>
                    <td class="menu">備考：</td>
                    <td><textarea name="remark"></textarea></td>
                </tr>
                <tr>
                    <td class="menu">予約者名：</td>
                    <td><input type="text" name="name" maxlength="20" required></td>
                </tr>
                <tr>
                    <td class="menu">パスワード：</td>
                    <td><input type="password" name="password" required></td>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="submit" name="form_confirm" value="確認"></td>
                </tr>
            </table>
            </form>
        <script>
            $(function () {
                //$('.multiple-select').multipleSelect('checkAll');
                $('.multiple-select').multipleSelect({
                    width: 250,
                    formatSelectAll: function() {
                        return 'バンド練習';
                    },
                    formatAllSelected: function() {
                        return 'バンド練習';
                    },
                    placeholder: '使用パートを選択してください'
                });
            });
        </script>
        </div>
        _HTML_;
    }

    function confirm(){
        global $select_day, $time, $select_time, $regist_name, $part, $otherpart, $remark, $name, $password_len, $uniq_name;
        $part_jp = ['ボーカル', 'ギター(マーシャル)', 'ギター(ジャズコーラス)', 'ベース', 'ドラム', 'キーボード', 'その他'];
        $otherpart_jp = ['なし', 'あり'];
        $prime_num = [2,3,5,7,11,13,17];

        $part_each = NULL;

        if(count($part) == 7){
            $part_each .= 'バンド';
        }
        else{
            foreach($part as $i){
                $j = array_search($i, $prime_num);
                $part_each .= $part_jp[$j] . ' ';
            }
        }
    

        echo <<<_HTML_
        <div id="bookingConfirm">
            <h1 class="title">信州大学軽音楽部 予約フォーム確認</h1>
            <form method="POST" action="">
            <table>
                <tr>
                    <td class="menu">予約日：</td>
                    <td> $select_day </td>
                </tr>
                <tr>
                    <td class="menu">予約時間：</td>
                    <td> $time[$select_time] </td>
                </tr>
                <tr>
                    <td class="menu">登録名：</td>
                    <td> $regist_name </td>
                </tr>
                <tr>
                    <td class="menu">パート：</td>
                    <td> $part_each </td>
                </tr>
                <tr>
                    <td class="menu">他パート参加：</td>
                    <td> $otherpart_jp[$otherpart] </td>
                </tr>
                <tr>
                    <td class="menu">備考：</td>
                    <td> $remark </td>
                </tr>
                <tr>
                    <td class="menu">予約者名：</td>
                    <td> $name </td>
                </tr>
                <tr>
                    <td class="menu">パスワード：</td>
                    <td><b> $password_len </b></td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <input type="hidden" name="uniq_csv" value="$uniq_name">
                        <input type="submit" name="form_back" value="戻る">
                        <input type="submit" name="form_submit" value="予約">
                    </td>
                </tr>
            </table>
            </form>
        </div>
        _HTML_;
    }

    function complete(){
        echo <<<_HTML_
        <div id="CompleteMain">
            <h1>完了しました！</h1>
            <button type="button" onclick="location.href='http://localhost/shindai_k_on/index.html'">ホームに戻る</button>
        </div>
        _HTML_;
    }

?>

<!doctype html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="https://unpkg.com/multiple-select@1.5.2/dist/multiple-select.min.css" rel="stylesheet">
    <link href="../common/css/base.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/multiple-select@1.5.2/dist/multiple-select.min.js"></script>
</head>
<body>
<header>
</header>
<main id="bookingMain">
    <?php
        if($page_flag == 1){
            confirm();
        }
        elseif($page_flag == 2){
            complete();
        }
        else{
            booking();
        }
    ?>

</main>
</body>
</html>